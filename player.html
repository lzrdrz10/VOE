<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VOE Player</title>

  <!-- VIDEO.JS -->
  <link href="https://vjs.zencdn.net/8.3.0/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.3.0/video.min.js"></script>

  <!-- QUALITY SELECTOR -->
  <link rel="stylesheet" href="quality-selector.css">
  <script src="silvermine-videojs-quality-selector.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{overflow:hidden;background:#000;font-family:Arial,Helvetica,sans-serif;}
    .mainPlayer{width:100%!important;height:100vh!important;position:absolute;}
    .video-js .vjs-control-bar{
      background:linear-gradient(to top,rgba(0,0,0,.55),transparent);
      height:55px;padding:0 10px;
    }
    .video-js .vjs-control{color:#fff;opacity:.85;transition:.2s;}
    .video-js .vjs-control:hover{opacity:1;}
    .video-js .vjs-big-play-button{
      height:80px!important;width:80px!important;border-radius:50%;
      border:none;background:rgba(0,0,0,.45);transition:.25s;
    }
    .video-js .vjs-big-play-button:hover{background:rgba(255,255,255,.3);}
    .video-js .vjs-big-play-button .vjs-icon-play:before{font-size:48px;}
    .video-js .vjs-progress-holder{
      height:6px!important;border-radius:20px;background:rgba(255,255,255,.25);margin-top:18px;
    }
    .video-js .vjs-play-progress{background:#ff3355!important;border-radius:20px;}
    .video-js .vjs-load-progress div{background:rgba(255,255,255,.35)!important;}
    .video-js .vjs-volume-bar{height:6px!important;border-radius:20px;}
    .video-js .vjs-volume-level{background:#ff3355!important;border-radius:20px;}
    .video-js .vjs-time-control{font-size:14px;color:#fff;}
    .video-js .vjs-menu-button-popup .vjs-menu{
      background:rgba(0,0,0,.85)!important;border-radius:10px;padding:8px 0;
    }
    .video-js .vjs-menu li{color:#fff!important;}
    .video-js .vjs-menu li.vjs-selected{background:rgba(255,255,255,.12)!important;}
    .video-js .vjs-loading-spinner{border-top-color:#ff3355!important;border-left-color:#ff3355!important;}
    .video-js .vjs-time-tooltip{background:#000;padding:4px 6px;border-radius:6px;font-size:12px;}
    #loading{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      color:#ff3355;font-size:18px;text-align:center;z-index:9999;
    }
  </style>
</head>
<body>
  <video id="my-video" class="video-js mainPlayer" controls preload="auto">
    <p class="vjs-no-js">Activa JavaScript para ver este video.</p>
  </video>

  <div id="loading">Cargando calidades…</div>

  <script>
    // ---------- 1. Obtener ID ----------
    function getParam(name){
      const r = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const m = r.exec(location.search);
      return m ? decodeURIComponent(m[1]) : '';
    }
    const videoId = getParam('url');
    if (!videoId || !/^\d+$/.test(videoId)){
      document.getElementById('loading').innerHTML = `
        <div style="color:#f44;font-size:16px;">
          <strong>Error:</strong> ID no válido<br>
          Usa: <code>player.html?url=1234567890</code>
        </div>`;
      throw '';
    }

    // ---------- 2. CORS proxy (gratuito y fiable) ----------
    const proxy = 'https://corsproxy.io/?';
    const embedUrl = `https://ok.ru/videoembed/${videoId}`;

    // ---------- 3. Fetch del embed ----------
    fetch(proxy + encodeURIComponent(embedUrl))
      .then(r => { if (!r.ok) throw 'Video no encontrado'; return r.text(); })
      .then(html => {
        document.getElementById('loading').remove();

        // ---- extraer __videoData ----
        const dataMatch = html.match(/window\.__videoData\s*=\s*(\{.*?\});\s*</);
        if (!dataMatch) throw 'No se encontró __videoData';

        const data = JSON.parse(dataMatch[1]);

        // ---- poster ----
        const poster = data.poster || '';

        // ---- calidades ----
        const qualityLabels = { '1080':'1080p','720':'720p','480':'480p','360':'360p','240':'240p','144':'144p' };
        const sources = (data.videos || []).map(v => ({
          src: v.url,
          type: 'video/mp4',
          label: qualityLabels[v.name] || v.name + 'p',
          // 360p por defecto si existe, sino la primera
          selected: v.name === '360'
        })).reverse();   // 1080p arriba

        if (sources.length === 0) throw 'No hay streams disponibles';

        // ---------- 4. Video.js ----------
        const player = videojs('my-video', {
          controls: true,
          preload: 'auto',
          poster: poster,
          sources: sources,
          controlBar: { skipButtons: { forward:10, backward:10 } }
        }, function(){
          this.controlBar.addChild('QualitySelector');
        });

        // Opcional: título
        document.title = (data.metadata?.title || 'VOE Player').replace(/ - OK\.RU.*$/, '');

      })
      .catch(err => {
        document.getElementById('loading').remove();
        document.body.innerHTML += `
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                      color:#f44;background:rgba(0,0,0,.8);padding:20px;border-radius:12px;
                      text-align:center;max-width:90%;font-size:16px;">
            <strong>Error:</strong> ${err}<br><br>
            <small>ID: ${videoId}<br>Verifica que el video sea público.</small>
          </div>`;
      });
  </script>
</body>
</html>
